<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¤ëŠ˜ì˜ ê°ì •</title>
<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
  <style>
   body, button, input, textarea {font-family: 'Pretendard', 'Apple SD Gothic Neo', sans-serif; 800px; margin: auto; padding: 20px; }
    h1, h2 { text-align: center; }
    .box { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
    #moods { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .mood-btn { width:100%; height:70px; font-size:18px; border-radius:16px; border:none; background:#f0f0f0; transition:0.2s; cursor:pointer; }
    .mood-btn:hover { transform: scale(1.05); }
    .selected { background:#ffe08a; }
    input, textarea { width:100%; padding:8px; margin-top:6px; border-radius:10px; border:1px solid #ddd; }
    button { background:#4f7cff; color:white; border-radius:12px; border:none; font-weight:bold; padding:10px 16px; margin-top:10px; cursor:pointer; }
    button:hover { background:#3d66d6; }
    .alert { background:#ffe0e0; padding:10px; margin:10px 0; border:1px solid #ff8080; border-radius:12px; font-weight:bold; }
  .mood-btn { color: #000 !important; }
  .selected { color: #000 !important; }
body, button, input, textarea, select {
  font-family: 'Jua', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif !important;}
  </style>
</head>
<body>
  <h1>ì˜¤ëŠ˜ì˜ ê°ì •ì€ ì–´ë–¤ê°€ìš”?</h1>

  <div class="box">
    <p>ì˜¤ëŠ˜ ë‚ ì§œ(ì¸í„°ë„· ê¸°ì¤€): <b id="todayLabel">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</b></p>

    <label>ì´ë¦„</label>
    <input id="name" placeholder="ì´ë¦„ ì…ë ¥" />
    <small>ì²˜ìŒ í•œ ë²ˆë§Œ ì…ë ¥í•˜ë©´ ë‹¤ìŒë¶€í„° ìë™ìœ¼ë¡œ ê¸°ì–µí•©ë‹ˆë‹¤.</small>

    <p>ì˜¤ëŠ˜ ê¸°ë¶„ì„ ê³¨ë¼ì£¼ì„¸ìš” (5ë‹¨ê³„)</p>
    <div id="moods"></div>

    <label>ê·¸ ì´ìœ ëŠ”?</label>
    <textarea id="reason" rows="3"></textarea>

    <button onclick="saveRecord()">ì €ì¥</button>
    <p id="msg"></p>
  </div>

  <script>
    const moodLabels = ["ë§¤ìš° ì¢‹ìŒ ğŸ˜Š", "ì¢‹ìŒ ğŸ™‚", "ë³´í†µ ğŸ˜", "ë‚˜ì¨ ğŸ™", "ë§¤ìš° ë‚˜ì¨ ğŸ˜¢"];
    let selectedMood = null;
    let currentDate = null;

    // ì´ë¦„ ê¸°ì–µ
    const savedName = localStorage.getItem('studentName');
    if(savedName){ document.getElementById('name').value = savedName; }

    // ê¸°ë¶„ ë²„íŠ¼ ìƒì„±
    const moodsDiv = document.getElementById("moods");
    moodLabels.forEach((m, i) => {
      const btn = document.createElement("button");
      btn.className = "mood-btn";
      btn.innerText = m;
      btn.onclick = () => selectMood(i, btn);
      moodsDiv.appendChild(btn);
    });

    function selectMood(i, btn) {
      selectedMood = i;
      document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    }

    // ì¸í„°ë„· ë‚ ì§œ
    async function loadInternetDate(){
      try{
        const res = await fetch('https://worldtimeapi.org/api/ip');
        const data = await res.json();
        currentDate = data.datetime.slice(0,10);
        document.getElementById('todayLabel').innerText = currentDate;
      }catch(e){
        const d = new Date();
        currentDate = d.toISOString().slice(0,10);
        document.getElementById('todayLabel').innerText = currentDate + ' (ë¡œì»¬ì‹œê°„)';
      }
    }
    loadInternetDate();

    function alreadySubmittedToday(name){
      const data = JSON.parse(localStorage.getItem("moodRecords") || "[]");
      return data.some(r => r.name === name && r.date === currentDate);
    }

    function saveRecord() {
      const name = document.getElementById("name").value.trim();
      const reason = document.getElementById("reason").value.trim();
      if (!name || selectedMood === null) {
        document.getElementById("msg").innerText = "ì´ë¦„ê³¼ ê¸°ë¶„ì„ ì„ íƒí•˜ì„¸ìš”.";
        return;
      }
      if(!currentDate){
        document.getElementById("msg").innerText = "ë‚ ì§œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘";
        return;
      }
      if(alreadySubmittedToday(name)){
        document.getElementById("msg").innerText = "ì˜¤ëŠ˜ì€ ì´ë¯¸ ì…ë ¥í–ˆìŠµë‹ˆë‹¤.";
        return;
      }

      const data = JSON.parse(localStorage.getItem("moodRecords") || "[]");
      const record = { name, moodIndex: selectedMood, mood: moodLabels[selectedMood], reason, date: currentDate };
      data.push(record);
      localStorage.setItem("moodRecords", JSON.stringify(data));
      localStorage.setItem("studentName", name);

      document.getElementById("msg").innerText = checkStreakAlert(name, data) || "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
      document.getElementById("reason").value = "";
      selectedMood = null;
      document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
    }

    // 3ì¼ ì—°ì† ë‚˜ì¨ ê²½ê³ (í•™ìƒì—ê²Œë„ í‘œì‹œ)
    function checkStreakAlert(name, data){
      const list = data.filter(r=>r.name===name).sort((a,b)=>a.date.localeCompare(b.date));
      let streak=0;
      for(let i=list.length-1;i>=0;i--){
        if(list[i].moodIndex>=3){
          if(i===list.length-1 || isPrevDay(list[i].date, list[i+1]?.date)) streak++;
          else break;
        } else break;
      }
      if(streak>=3) return `âš  ${streak}ì¼ ì—°ì† ê¸°ë¶„ì´ ì¢‹ì§€ ì•ŠìŠµë‹ˆë‹¤.`;
      return "";
    }

    function isPrevDay(d1, d2){
      const a=new Date(d1), b=new Date(d2);
      a.setDate(a.getDate()+1);
      return a.toISOString().slice(0,10)===b.toISOString().slice(0,10);
    }
  </script>
</body>
</html>
